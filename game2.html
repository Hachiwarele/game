<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GAME2</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    background-color: #000;
    background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
    background-size: cover;
    font-family: sans-serif;
    color: white;
  }

  #player {
    position: absolute;
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #4fc3f7, #0288d1);
    border-radius: 8px;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 0 15px #4fc3f7;
    transition: background 0.2s;
  }

  .enemy {
    position: absolute;
    width: 35px;
    height: 35px;
    background: linear-gradient(135deg, #ff5252, #b71c1c);
    border-radius: 6px;
    box-shadow: 0 0 12px #ff1744;
  }

  .bullet {
    position: absolute;
    width: 8px;
    height: 20px;
    background: yellow;
    border-radius: 4px;
    box-shadow: 0 0 10px yellow;
  }

  #score {
    position: absolute;
    top: 15px;
    left: 20px;
    font-size: 26px;
    letter-spacing: 2px;
    text-shadow: 0 0 10px #4fc3f7;
  }

  #gameover {
    position: absolute;
    top: 35%;
    width: 100%;
    text-align: center;
    font-size: 60px;
    display: none;
    text-shadow: 0 0 20px #ff1744;
    white-space: pre-line;
  }

  #buttons {
    position: absolute;
    top: 60%;
    width: 100%;
    text-align: center;
    display: none;
  }
  #buttons button {
    font-size: 26px;
    padding: 12px 25px;
    margin: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #4fc3f7;
    color: #000;
    box-shadow: 0 0 10px #4fc3f7;
  }
  #buttons button:hover {
    background: #81d4fa;
  }
</style>
</head>
<body>

<div id="player"></div>
<div id="score">SCORE: 0</div>
<div id="gameover"></div>
<div id="buttons">
  <button onclick="location.reload()">リトライ</button>
  <button onclick="location.href='index.html'">タイトルへ</button>
</div>

<script>
const player = document.getElementById("player");
const scoreText = document.getElementById("score");
const gameoverText = document.getElementById("gameover");
const buttons = document.getElementById("buttons");

let px = window.innerWidth / 2 - 20;
let speed = 8;
let score = 0;
let gameOver = false;

let canShoot = true;
let keys = { left: false, right: false };

/* 入力 */
document.addEventListener("keydown", e => {
  if (e.code === "ArrowLeft") keys.left = true;
  if (e.code === "ArrowRight") keys.right = true;
  if (e.code === "Space") shoot();
});
document.addEventListener("keyup", e => {
  if (e.code === "ArrowLeft") keys.left = false;
  if (e.code === "ArrowRight") keys.right = false;
});

document.addEventListener("touchstart", e => {
  const x = e.touches[0].clientX;
  if (x < window.innerWidth * 0.33) keys.left = true;
  else if (x > window.innerWidth * 0.66) keys.right = true;
  else shoot();
});
document.addEventListener("touchend", () => {
  keys.left = false;
  keys.right = false;
});

/* 当たり判定（矩形＋少し縮める） */
function isHit(a, b, shrink = 4) {
  if (!a || !b) return false;
  const ra = a.getBoundingClientRect();
  const rb = b.getBoundingClientRect();

  const aLeft   = ra.left   + shrink;
  const aRight  = ra.right  - shrink;
  const aTop    = ra.top    + shrink;
  const aBottom = ra.bottom - shrink;

  const bLeft   = rb.left   + shrink;
  const bRight  = rb.right  - shrink;
  const bTop    = rb.top    + shrink;
  const bBottom = rb.bottom - shrink;

  return (
    aLeft < bRight &&
    aRight > bLeft &&
    aTop < bBottom &&
    aBottom > bTop
  );
}

/* 弾を撃つ */
function shoot() {
  if (!canShoot || gameOver) return;

  canShoot = false;
  player.style.background = "#76ff03";

  const b = document.createElement("div");
  b.className = "bullet";
  const playerRect = player.getBoundingClientRect();
  b.style.left = (playerRect.left + playerRect.width / 2 - 4) + "px";
  b.style.top = (playerRect.top - 20) + "px";
  document.body.appendChild(b);

  function fly() {
    if (gameOver) return;

    const top = parseInt(b.style.top);
    b.style.top = (top - 12) + "px";

    document.querySelectorAll(".enemy").forEach(e => {
      if (e.dead) return;
      if (isHit(b, e, 2)) {
        e.dead = true;
        e.remove();
        b.remove();
        score++;
        scoreText.textContent = "SCORE: " + score;
      }
    });

    if (parseInt(b.style.top) > -40 && b.isConnected) {
      requestAnimationFrame(fly);
    } else if (b.isConnected) {
      b.remove();
    }
  }
  fly();

  setTimeout(() => {
    canShoot = true;
    player.style.background = "linear-gradient(135deg, #4fc3f7, #0288d1)";
  }, 3000);
}

/* 敵生成 */
function spawnEnemy() {
  if (gameOver) return;

  const e = document.createElement("div");
  e.className = "enemy";
  e.style.left = Math.random() * (window.innerWidth - 35) + "px";
  e.style.top = "-50px";
  e.dead = false;
  document.body.appendChild(e);

  let fallSpeed = 4 + Math.random() * 5 + score * 0.05;

  function fall() {
    if (gameOver || e.dead || !e.isConnected) return;

    const top = parseInt(e.style.top);
    e.style.top = (top + fallSpeed) + "px";

    if (isHit(player, e, 6)) {
      endGame();
      return;
    }

    if (parseInt(e.style.top) < window.innerHeight) {
      requestAnimationFrame(fall);
    } else {
      if (!e.dead && e.isConnected) {
        score++;
        scoreText.textContent = "SCORE: " + score;
      }
      e.remove();
    }
  }

  fall();
  setTimeout(spawnEnemy, 500 + Math.random() * 300);
}

/* プレイヤー移動 */
function loop() {
  if (gameOver) return;

  if (keys.left) px -= speed;
  if (keys.right) px += speed;

  px = Math.max(0, Math.min(window.innerWidth - 45, px));
  player.style.left = px + "px";

  requestAnimationFrame(loop);
}

/* ゲームオーバー */
function endGame() {
  gameOver = true;
  gameoverText.textContent = `GAME OVER\nSCORE: ${score}`;
  gameoverText.style.display = "block";
  buttons.style.display = "block";
}

spawnEnemy();
loop();
</script>

</body>
</html>
