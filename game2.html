<script>
const player = document.getElementById("player");
const scoreText = document.getElementById("score");
const gameoverText = document.getElementById("gameover");
const buttons = document.getElementById("buttons");

let px = window.innerWidth / 2 - 20;
let speed = 8;
let score = 0;
let gameOver = false;

let canShoot = true;
let keys = { left: false, right: false };

document.addEventListener("keydown", e => {
  if (e.code === "ArrowLeft") keys.left = true;
  if (e.code === "ArrowRight") keys.right = true;
  if (e.code === "Space") shoot();
});
document.addEventListener("keyup", e => {
  if (e.code === "ArrowLeft") keys.left = false;
  if (e.code === "ArrowRight") keys.right = false;
});

document.addEventListener("touchstart", e => {
  const x = e.touches[0].clientX;
  if (x < window.innerWidth * 0.33) keys.left = true;
  else if (x > window.innerWidth * 0.66) keys.right = true;
  else shoot();
});
document.addEventListener("touchend", () => {
  keys.left = false;
  keys.right = false;
});

/* 弾を撃つ */
function shoot() {
  if (!canShoot || gameOver) return;

  canShoot = false;
  player.style.background = "#76ff03";

  const b = document.createElement("div");
  b.className = "bullet";
  b.style.left = (px + 18) + "px";
  b.style.top = (window.innerHeight - 80) + "px";
  document.body.appendChild(b);

  let by = window.innerHeight - 80;

  function fly() {
    if (gameOver) return;

    by -= 12;
    b.style.top = by + "px";

    document.querySelectorAll(".enemy").forEach(e => {
      if (e.dead) return;

      const ex = parseInt(e.style.left);
      const ey = parseInt(e.style.top);

      if (
        by < ey + 35 &&
        by + 20 > ey &&
        px + 45 > ex &&
        px < ex + 35
      ) {
        e.dead = true;
        e.remove();
        b.remove();
        score++;
        scoreText.textContent = "SCORE: " + score;
      }
    });

    if (by > -40) requestAnimationFrame(fly);
    else b.remove();
  }
  fly();

  setTimeout(() => {
    canShoot = true;
    player.style.background = "linear-gradient(135deg, #4fc3f7, #0288d1)";
  }, 3000);
}

/* 敵生成 */
function spawnEnemy() {
  if (gameOver) return;

  const e = document.createElement("div");
  e.className = "enemy";
  e.style.left = Math.random() * (window.innerWidth - 35) + "px";
  e.style.top = "-50px";
  e.dead = false;
  document.body.appendChild(e);

  let ey = -50;
  let fallSpeed = 4 + Math.random() * 5 + score * 0.05;

  function fall() {
    if (gameOver || e.dead) return;

    ey += fallSpeed;
    e.style.top = ey + "px";

    const ex = parseInt(e.style.left);

    const playerLeft = px;
    const playerRight = px + 45;
    const playerTop = window.innerHeight - 60 - 45;
    const playerBottom = window.innerHeight - 60;

    const enemyLeft = ex;
    const enemyRight = ex + 35;
    const enemyTop = ey;
    const enemyBottom = ey + 35;

    if (
      playerLeft < enemyRight &&
      playerRight > enemyLeft &&
      playerTop < enemyBottom &&
      playerBottom > enemyTop
    ) {
      endGame();
      return;
    }

    if (ey < window.innerHeight) {
      requestAnimationFrame(fall);
    } else {
      if (!e.dead) {
        score++;
        scoreText.textContent = "SCORE: " + score;
      }
      e.remove();
    }
  }

  fall();
  setTimeout(spawnEnemy, 500 + Math.random() * 300);
}

/* プレイヤー移動 */
function loop() {
  if (gameOver) return;

  if (keys.left) px -= speed;
  if (keys.right) px += speed;

  px = Math.max(0, Math.min(window.innerWidth - 45, px));
  player.style.left = px + "px";

  requestAnimationFrame(loop);
}

/* ゲームオーバー */
function endGame() {
  gameOver = true;
  gameoverText.textContent = "GAME OVER\nSCORE: " + score;
  gameoverText.style.display = "block";
  buttons.style.display = "block";
}

spawnEnemy();
loop();
</script>
