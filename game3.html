<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GB TETRIS Stable</title>
<style>
html,body{
  margin:0;
  padding:0;
  height:100dvh;
  overflow:hidden;
  background:#dfead9;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
}
.wrap{
  width:100%;
  height:100%;
  max-width:900px;
  display:flex;
  flex-direction:column;
  padding:10px;
  box-sizing:border-box;
}
.main{
  flex:1;
  display:flex;
  gap:10px;
}
.left{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
.right{
  width:220px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.panel{
  background:#ffffffaa;
  border-radius:8px;
  padding:8px;
  text-align:center;
}
canvas{
  background:#cfeec7;
  border-radius:6px;
  image-rendering:pixelated;
}
.controls{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:8px;
}
.btn{
  background:#333;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  font-weight:bold;
  user-select:none;
}
.touch{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
}
.round{
  width:60px;
  height:60px;
  border-radius:50%;
  background:#444;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
}
@media(max-width:700px){
  .main{flex-direction:column;}
  .right{width:100%;flex-direction:row;flex-wrap:wrap;}
  .panel{flex:1;}
}
</style>
</head>
<body>
<div class="wrap">
<div class="main">
<div class="left">
<canvas id="board"></canvas>
<div class="controls">
<div class="btn" id="restart">RESTART</div>
<div class="btn" id="pause">PAUSE</div>
<div class="btn" id="holdBtn">HOLD</div>
</div>
</div>
<div class="right">
<div class="panel">
<div>NEXT</div>
<canvas id="next" width="160" height="160"></canvas>
</div>
<div class="panel">
<div>HOLD</div>
<canvas id="hold" width="160" height="160"></canvas>
</div>
<div class="panel">
<div>Score <span id="score">0</span></div>
<div>Lines <span id="lines">0</span></div>
</div>
</div>
</div>
<div class="touch">
<div class="round" id="left">◀</div>
<div class="round" id="down">▼</div>
<div class="round" id="right">▶</div>
<div class="round" id="rotate">↻</div>
<div class="round" id="hard">⤓</div>
</div>
</div>

<script>
const COLS=10, ROWS=20;
let CELL=30;
const boardCanvas=document.getElementById("board");
const ctx=boardCanvas.getContext("2d");
const nextCanvas=document.getElementById("next");
const nextCtx=nextCanvas.getContext("2d");
const holdCanvas=document.getElementById("hold");
const holdCtx=holdCanvas.getContext("2d");

let board, current, next, holdPieceData=null;
let canHold=true;
let running=true;
let paused=false;
let score=0, lines=0;
let dropInterval=800;
let last=0;

function resize(){
  const h=window.innerHeight-220;
  const w=window.innerWidth-260;
  CELL=Math.floor(Math.min(h/ROWS,w/COLS));
  if(CELL<12) CELL=12;
  boardCanvas.width=COLS*CELL;
  boardCanvas.height=ROWS*CELL;
}
window.addEventListener("resize",resize);
resize();

function emptyBoard(){
  return Array.from({length:ROWS},()=>Array(COLS).fill(0));
}
board=emptyBoard();

const SHAPES={
I:[[1,1,1,1]],
O:[[1,1],[1,1]],
T:[[0,1,0],[1,1,1]],
L:[[1,0],[1,0],[1,1]],
J:[[0,1],[0,1],[1,1]],
S:[[0,1,1],[1,1,0]],
Z:[[1,1,0],[0,1,1]]
};

function randomPiece(){
  const keys=Object.keys(SHAPES);
  const type=keys[Math.floor(Math.random()*keys.length)];
  return {type,x:3,y:0};
}

function drawCell(x,y,color){
  ctx.fillStyle=color;
  ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
}

function draw(){
  ctx.clearRect(0,0,boardCanvas.width,boardCanvas.height);
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(board[y][x]) drawCell(x,y,"#4aa0ff");
    }
  }
}

function merge(){
  const shape=SHAPES[current.type];
  for(let y=0;y<shape.length;y++){
    for(let x=0;x<shape[y].length;x++){
      if(shape[y][x]){
        board[current.y+y][current.x+x]=1;
      }
    }
  }
}

function clearLines(){
  let newBoard=[];
  let cleared=0;
  for(let y=0;y<ROWS;y++){
    if(board[y].every(v=>v)){
      cleared++;
    }else{
      newBoard.push(board[y]);
    }
  }
  while(newBoard.length<ROWS){
    newBoard.unshift(Array(COLS).fill(0));
  }
  board=newBoard;
  score+=cleared*100;
  lines+=cleared;
  document.getElementById("score").textContent=score;
  document.getElementById("lines").textContent=lines;
}

function update(time=0){
  if(!running||paused) return;
  if(time-last>dropInterval){
    current.y++;
    if(current.y+SHAPES[current.type].length>ROWS){
      current.y--;
      merge();
      clearLines();
      spawn();
    }
    last=time;
  }
  draw();
  requestAnimationFrame(update);
}

function spawn(){
  current=next||randomPiece();
  next=randomPiece();
  canHold=true;
}

function hold(){
  if(!canHold) return;
  if(!holdPieceData){
    holdPieceData=current;
    spawn();
  }else{
    [holdPieceData,current]=[current,holdPieceData];
  }
  canHold=false;
}

document.getElementById("restart").onclick=()=>{
  board=emptyBoard();
  score=0; lines=0;
  spawn();
};
document.getElementById("pause").onclick=()=>paused=!paused;
document.getElementById("holdBtn").onclick=hold;

spawn();
update();
</script>
</body>
</html>
